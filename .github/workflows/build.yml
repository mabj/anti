name: Build All Techniques

on:
  push:
    branches: [ master, main ]
    paths:
      - 'anti-debugging/**'
      - 'anti-sandbox/**'
      - 'anti-reversing/**'
  workflow_dispatch:

jobs:
  build:
    name: Build Techniques
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build techniques
      run: |
        set +e

        BUILD_FAILED=0
        BUILD_SUCCESS=0
        BUILD_SKIPPED=0

        echo "========================================="
        echo "Building Anti-Analysis Techniques"
        echo "========================================="
        echo ""

        for category in anti-debugging anti-sandbox anti-reversing; do
          if [ -d "$category" ]; then
            echo "Category: $category"
            echo "----------------------------------------"

            for dir in $category/[A-Z][A-Z][0-9][0-9][0-9]_*/; do
              if [ -d "$dir" ]; then
                TECHNIQUE=$(basename "$dir")
                echo "Building: $category/$TECHNIQUE"
                echo "----------------------------------------"

                cd "$dir"

                if [ -f "Dockerfile" ] && [ -f "Makefile" ]; then
                  mkdir -p bin

                  # Extract MAIN_NAME from Makefile for the Docker image tag
                  MAIN_NAME=$(grep '^MAIN_NAME=' Makefile | cut -d'=' -f2)

                  # Build the Docker image from the technique's Dockerfile
                  docker build . -t "$MAIN_NAME" -q

                  # Run the build inside the container (no -it for CI)
                  if docker run --rm -v "$(pwd):/experiment" -w /experiment "$MAIN_NAME" make 2>&1; then
                    echo "✓ Successfully built $category/$TECHNIQUE"
                    BUILD_SUCCESS=$((BUILD_SUCCESS + 1))
                  else
                    echo "✗ Failed to build $category/$TECHNIQUE"
                    BUILD_FAILED=$((BUILD_FAILED + 1))
                  fi
                else
                  echo "⊘ Missing Dockerfile or Makefile, skipping $category/$TECHNIQUE"
                  BUILD_SKIPPED=$((BUILD_SKIPPED + 1))
                fi

                cd ../..
                echo ""
              fi
            done
          fi
        done

        echo "========================================="
        echo "Build Summary"
        echo "========================================="
        echo "Successful: $BUILD_SUCCESS"
        echo "Failed: $BUILD_FAILED"
        echo "Skipped: $BUILD_SKIPPED"
        echo "========================================="

        if [ $BUILD_FAILED -gt 0 ]; then
          echo ""
          echo "⚠️  Some builds failed. Please review the output above."
          exit 1
        fi

        echo ""
        echo "✓ All builds completed successfully!"

    - name: Package artifacts
      if: success()
      run: |
        TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
        STAGING="staging"

        for category in anti-debugging anti-sandbox anti-reversing; do
          if [ -d "$category" ]; then
            find "$category" -path "*/bin/*.exe" -type f | while read -r exe; do
              mkdir -p "$STAGING/$category"
              cp "$exe" "$STAGING/$category/"
            done
          fi
        done

        tar -czf "anti_${TIMESTAMP}.tar.gz" -C "$STAGING" .

        echo "Archive contents:"
        tar -tzf "anti_${TIMESTAMP}.tar.gz"
        echo ""
        echo "Created anti_${TIMESTAMP}.tar.gz ($(du -h "anti_${TIMESTAMP}.tar.gz" | cut -f1))"
        echo "archive_name=anti_${TIMESTAMP}" >> "$GITHUB_OUTPUT"
      id: package

    - name: Upload archive
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.package.outputs.archive_name }}
        path: anti_*.tar.gz
        retention-days: 30

    - name: Build statistics
      if: always()
      run: |
        echo "Build Statistics"
        echo "================"
        TOTAL_DIRS=$(find anti-debugging anti-sandbox anti-reversing -maxdepth 1 -type d -name "[A-Z][A-Z][0-9][0-9][0-9]_*" 2>/dev/null | wc -l)
        TOTAL_MAKEFILES=$(find anti-debugging anti-sandbox anti-reversing -name "Makefile" 2>/dev/null | wc -l)
        TOTAL_BINARIES=$(find anti-debugging anti-sandbox anti-reversing -name "*.exe" 2>/dev/null | wc -l)

        echo "Total technique directories: $TOTAL_DIRS"
        echo "Directories with Makefile: $TOTAL_MAKEFILES"
        echo "Total binaries built: $TOTAL_BINARIES"
