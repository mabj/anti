name: Build All Techniques

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Techniques
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install MinGW cross-compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 gcc make

    - name: Find all techniques
      id: find-techniques
      run: |
        echo "Found techniques:"
        find anti-debugger anti-sandbox anti-reversing -maxdepth 1 -type d -name "[0-9][0-9][0-9]_*" 2>/dev/null | sort || echo "No technique directories found"

    - name: Build techniques
      run: |
        set +e  # Don't fail on first error

        BUILD_FAILED=0
        BUILD_SUCCESS=0
        BUILD_SKIPPED=0

        echo "========================================="
        echo "Building Anti-Analysis Techniques"
        echo "========================================="
        echo ""

        # Build techniques from all category directories
        for category in anti-debugger anti-sandbox anti-reversing; do
          if [ -d "$category" ]; then
            echo "Category: $category"
            echo "----------------------------------------"

            for dir in $category/[0-9][0-9][0-9]_*/; do
              if [ -d "$dir" ]; then
                TECHNIQUE=$(basename "$dir")
                echo "Building: $category/$TECHNIQUE"
                echo "----------------------------------------"

                cd "$dir"

                # Check if Makefile exists
                if [ -f "Makefile" ]; then
                  # Create bin directory if it doesn't exist
                  mkdir -p bin

                  # Try to build without Docker first (direct compilation)
                  if make build-x86 build-amd64 2>&1; then
                    echo "✓ Successfully built $category/$TECHNIQUE"
                    BUILD_SUCCESS=$((BUILD_SUCCESS + 1))
                  else
                    echo "✗ Failed to build $category/$TECHNIQUE"
                    BUILD_FAILED=$((BUILD_FAILED + 1))
                  fi
                else
                  echo "⊘ No Makefile found, skipping $category/$TECHNIQUE"
                  BUILD_SKIPPED=$((BUILD_SKIPPED + 1))
                fi

                cd ../..
                echo ""
              fi
            done
          fi
        done

        echo "========================================="
        echo "Build Summary"
        echo "========================================="
        echo "Successful: $BUILD_SUCCESS"
        echo "Failed: $BUILD_FAILED"
        echo "Skipped: $BUILD_SKIPPED"
        echo "========================================="

        # Exit with error if any builds failed
        if [ $BUILD_FAILED -gt 0 ]; then
          echo ""
          echo "⚠️  Some builds failed. Please review the output above."
          exit 1
        fi

        echo ""
        echo "✓ All builds completed successfully!"

    - name: List built binaries
      if: success()
      run: |
        echo "Built binaries:"
        find anti-debugger anti-sandbox anti-reversing -name "*.exe" -type f 2>/dev/null | sort

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: anti-analysis-techniques
        path: |
          anti-debugger/*/bin/*.exe
          anti-sandbox/*/bin/*.exe
          anti-reversing/*/bin/*.exe
        retention-days: 30

    - name: Build statistics
      if: always()
      run: |
        echo "Build Statistics"
        echo "================"
        TOTAL_DIRS=$(find anti-debugger anti-sandbox anti-reversing -maxdepth 1 -type d -name "[0-9][0-9][0-9]_*" 2>/dev/null | wc -l)
        TOTAL_MAKEFILES=$(find anti-debugger anti-sandbox anti-reversing -name "Makefile" 2>/dev/null | wc -l)
        TOTAL_BINARIES=$(find anti-debugger anti-sandbox anti-reversing -name "*.exe" 2>/dev/null | wc -l)

        echo "Total technique directories: $TOTAL_DIRS"
        echo "Directories with Makefile: $TOTAL_MAKEFILES"
        echo "Total binaries built: $TOTAL_BINARIES"
