# Context

This anti-debug technique leverages the ICEBP instruction (opcode [`0xF1`](038_INT1_prefix/src/main.c:32)) prefixed with instruction prefixes to detect debugger presence. The technique dynamically generates shellcode containing a REP prefix ([`0xF3`](038_INT1_prefix/src/main.c:30)), FS segment prefix ([`0x64`](038_INT1_prefix/src/main.c:31)), followed by the ICEBP instruction. When executed, debuggers typically intercept the single-step exception generated by ICEBP before it reaches the application's Vectored Exception Handler (VEH), while normal execution allows the VEH to catch it. By checking whether the exception was handled by the VEH or swallowed by the debugger, the code can reliably detect debugging activity.

- **Prefix obfuscation**: Uses REP (`0xF3`) and FS segment (`0x64`) prefixes before ICEBP to create an unusual instruction sequence
- **Exception-based detection**: Relies on the fact that debuggers handle prefixed ICEBP exceptions differently than normal VEH handlers
- **Detection mechanism**: If [`SwallowedException`](038_INT1_prefix/src/main.c:5) remains `true`, the debugger intercepted the exception; if it becomes `false`, the VEH caught it (no debugger)
- **Runtime generation**: Builds the shellcode dynamically in allocated executable memory to evade static analysis
- **Clean exception handling**: Uses [`AddVectoredExceptionHandler`](038_INT1_prefix/src/main.c:17) to register a custom handler that catches `EXCEPTION_SINGLE_STEP` and continues execution

## Key Points

- **ICEBP instruction**: Opcode `0xF1`, also known as INT 1, originally used for in-circuit emulation debugging
- **Single-byte breakpoint**: Unlike the standard INT3 (`0xCC`), ICEBP is a privileged single-byte instruction
- **Debugger interception**: Most debuggers handle ICEBP specially and intercept it before application exception handlers
- **VEH-based detection**: Uses Vectored Exception Handling to determine if the exception reached the application or was swallowed by the debugger
- **Dynamic shellcode**: Generates the instruction at runtime to avoid static analysis detection

## References

- <https://anti-debug.checkpoint.com/techniques/assembly.html#instruction_prefixes>
